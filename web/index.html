<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" type="text/css" href="css/style.css" media="screen" />

    <title>Demo</title>
    <link rel="canonical" href="https://lurklurk.org/skreate/" />
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Demo</h1>
        <h2>Convert text into skating diagram</h2>
      </div>
    </header>

    <div id="main">

      <section id="demo">
        <table align="center" class="inner">
          <tr>
            <td>
            <h3>Demo. Try editing me below</h3>
            <div class="editor-wrapper">
              <div class="editor">text goes here</div>
            </div>
            <a href="#" class="download">Download as SVG</a>
            </td>
            <td class="diagram">Is Javascript enabled?
            </td>
          </tr>
        </table>
      </section>

    </div>

    <footer>
      <hr />
      <div class="inner">
        <a href="https://lurklurk.org">David Drysdale<a> - <a href="https://github.com/daviddrysdale">GitHub</a>
      </div>
    </footer>

    <!-- jQuery for $ and friends -->
    <script src="third_party/js/jquery-3.7.1.min.js"></script>
    <!-- Use Ace as the text editor -->
    <script src="third_party/js/ace-1.33.2.min.js" type="text/javascript" charset="utf-8"></script>
    <!-- Borrow debounce from underscore -->
    <script src="third_party/js/underscore-fragments-1.13.6.js" type="text/javascript" charset="utf-8"></script>

    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">
      // Use ES module import syntax to import functionality from the module
      // that we have compiled.
      //
      // Note that the `default` import is an initialization function which
      // will "boot" the module and make it ready to use. Currently browsers
      // don't support natively imported WebAssembly as an ES module, but
      // eventually the manual initialization won't be required!
      import init, { initialize, generate } from '../wasm/pkg/skreate_wasm.js';

      async function run() {
        // First up we need to actually load the wasm file, so we use the
        // default export to inform it where the wasm file is located on the
        // server, and then we wait on the returned promise to wait for the
        // wasm to be loaded.
        await init();

        // And afterwards we can use all the functionality defined in wasm.
        initialize();
        const result = generate("abcd");
        console.log(`message = ${result}`);
      }

      run();
    </script>
    <script type="text/javascript">

      function setup_editor(div) {
        var editor_div = div.find(".editor");
        var editor = ace.edit(editor_div.get(0));
        editor.getSession().on('change', debounce(on_change, 100));

        var download_link = div.find('.download');
        download_link.click(function(ev) {
          var svg = diagram_div.find('svg')[0];
          var width = parseInt(svg.width.baseVal.value);
          var height = parseInt(svg.height.baseVal.value);
          var data = editor.getValue();
          var xml = '<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="' + width + '" height="' + height + '" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[' + data + ']]></source>' + svg.innerHTML + '</svg>';

          var a = $(this);
          a.attr("download", "diagram.svg");
          a.attr("href", "data:image/svg+xml," + encodeURIComponent(xml));
        });

        var diagram_div = div.find(".diagram");

        on_change();

        function on_change() {
          try {
            var diagram = Diagram.parse(editor.getValue());

            // Clear out old diagram and editor annotations.
            editor.getSession().setAnnotations([]);
            diagram_div.html('');

            var options = { scale: 1 };

            // Ask the diagram object to draw itself into the relevant div.
            diagram.drawSVG(diagram_div.get(0), options);

          } catch(err) {
            var annotation = {
              type: "error", // also warning and information
              column: 0,
              row: 0,
              text: err.message
            };
            if (err instanceof Diagram.Error) {
              annotation.row    = err.loc.first_line - 1;
              annotation.column = err.loc.first_column;
            }
            editor.getSession().setAnnotations([annotation]);
            throw err;
          }
        }
      }

      $(document).ready(function() {
        setup_editor($('#demo'));
      });
    </script>
  </body>
</html>
